<project name="maven-wolifecycle-ant-tasks" xmlns:artifact="antlib:org.apache.maven.artifact.ant">

	<target name="initTaskDefs">

		<taskdef name="woapplication" classname="org.objectstyle.woproject.ant.WOApplication">
		</taskdef>
		<taskdef name="woframework" classname="org.objectstyle.woproject.ant.WOFramework">
		</taskdef>

	</target>

	<target name="test-pom" depends="initTaskDefs">
		
		<artifact:pom file="pom.xml" id="pom.xml.project" />
		<!--xmlproperty file="pom.xml" prefix="pom.xml" keepRoot="true" / -->
			
		<echo>Artifact ID = ${pom.xml.project.artifactId}</echo>
		<echo>Artifact version = ${pom.xml.project.version}</echo>
		
	</target>

	<!-- ================================================================== -->
	<!-- W O A P L L I C A T I O N P R O P E R T I E S                      -->
	<!-- ================================================================== -->
	<target name="woapplicationproperties" depends="test-pom">
		<property file="build.properties" />
		<property file="target/wobuild.properties" />
		

		<property file="target/classpath.properties" />
		<echo>dependencies.lib ${dependencies.lib}</echo>
		<!-- property file="${user.home}${file.separator}Library${file.separator}wobuild.properties" />
		<condition property="wobuild.properties.check.failed">
			<not>
				<and>
					<isset property="wo.wosystemroot" />
					<isset property="wo.wolocalroot" />
				</and>
			</not>
		</condition>
		<fail message="Could not find ${user.home}${file.separator}Library${file.separator}wobuild.properties." if="wobuild.properties.check.failed" / -->
		<condition property="dependencies.lib.check.failed">
			<not>
				<isset property="dependencies.lib" />
			</not>
		</condition>
		<fail message="dependencies.lib is not set" if="dependencies.lib.check.failed" />
	</target>

	<target name="build-woapplication" depends="woapplicationproperties">
		<echo>dependencies.lib ${dependencies.lib}</echo>
		
		 <delete>
		    <fileset dir="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woa" includes="**/*.jar">
				<patternset>
					<excludesfile name="target/classpath.txt" />
				</patternset>
		    </fileset>
		  </delete>
		
		
		<woapplication name="${pom.xml.project.artifactId}-${pom.xml.project.version}"
			frameworksBaseURL="/WebObjects/${pom.xml.project.artifactId}-${pom.xml.project.version}.woa/Contents/Frameworks"
			startupScriptName="${pom.xml.project.artifactId}"
			stdFrameworks="false" destDir="target"
			customInfoPListContent="${customInfoPListContent}"
			principalClass="${principalClass}">
			<classes dir="target/classes">
			</classes>
			<lib dir="${dependencies.lib}">
				<patternset>
					<includesfile name="target/classpath.txt" />
				</patternset>
			</lib>
		</woapplication>

		<tar tarfile="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woapplication.tar" longfile="gnu">
			<tarfileset dir="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woa/"
				prefix="${pom.xml.project.artifactId}-${pom.xml.project.version}.woa/"
						preserveLeadingSlashes="true">
				<!-- exclude name="**/Contents/WebServerResources/**"/>
				<exclude name="**/Contents/Frameworks/**"/ -->
			</tarfileset>
		</tar>

		<gzip src="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woapplication.tar"
			  zipfile="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woapplication.tar.gz"/>
		<delete file="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woapplication.tar"/>

		<!-- force WebServerResourcesDir -->
		
		<mkdir dir="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woa/Contents/WebServerResources"/>
		
		<tar tarfile="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.wowebserverresources.tar" longfile="gnu">
			<tarfileset dir="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.woa/"
				prefix="${pom.xml.project.artifactId}-${pom.xml.project.version}.woa/"
						preserveLeadingSlashes="true">
				<include name="**/WebServerResources/**"/>
			</tarfileset>
		</tar>

		<gzip src="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.wowebserverresources.tar"
			  zipfile="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.wowebserverresources.tar.gz"/>
		<delete file="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.wowebserverresources.tar"/>
	</target>

	<!-- ================================================================== -->
	<!-- W O F R A M E W O R K P R O P E R T I E S                          -->
	<!-- ================================================================== -->
	<target name="woframeworkproperties" depends="test-pom">
		<property file="build.properties" />
		<property file="${user.home}${file.separator}Library${file.separator}wobuild.properties" />
		<condition property="wobuild.properties.check.failed">
			<not>
				<and>
					<isset property="wo.wosystemroot" />
					<isset property="wo.wolocalroot" />
				</and>
			</not>
		</condition>
	</target>

	<target name="build-woframework" depends="woframeworkproperties">
		<woframework name="${pom.xml.project.artifactId}" destDir="target" customInfoPListContent="${customInfoPListContent}" principalClass="${principalClass}" eoAdaptorClassName="${eoAdaptorClassName}">
			<classes dir="target/classes">
			</classes>
		</woframework>
		<zip zipfile="target/${pom.xml.project.artifactId}-${pom.xml.project.version}.jar" roundup="false">
			<fileset dir="target/${pom.xml.project.artifactId}.framework">
				<exclude name="**/Java/**"/>
			</fileset>
			<fileset dir="target/classes">
			</fileset>
		</zip>
	</target>
</project>